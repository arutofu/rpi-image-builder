name: Modify Raspberry Pi OS Image

on:
  push: # Запуск действия при каждом пуше в репозиторий
    branches:
      - main
  release:
    types: [created]

jobs:
  prepare-image:
    uses: ./.github/workflows/prepare-image.yml
    with:
      zip-image-path: https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-07-04/2024-07-04-raspios-bookworm-arm64-lite.img.xz

  configure-image:
    needs: prepare-image
    uses: ./.github/workflows/configure-image.yml
    with:
      username: pi
      password: raspberry

  test-image:
    needs: configure-image
    uses: ./.github/workflows/test-image.yml

  zip-image:
    needs: test-image
    uses: ./.github/workflows/zip-image.yml

  modify-image:
    runs-on: ubuntu-latest # Использование последней версии Ubuntu для выполнения задач
    steps:
      - name: deploy img.xz
        uses: softprops/action-gh-release@v1
        if: ${{ github.event_name == 'release'}}
        with:
          files: raspios.img.xz
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
